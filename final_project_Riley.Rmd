---
title: "Immigration and Reviatilzation in Philadelphia"
author: "Jake Riley"
output: html_document
---

Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Due dates:

- Topic choice: 9/18/15
- List of faculty/staff to be contacted: 10/2/15
- Complete overview with data source to address a specific problem identified: 10/16/15
- Introduction: 10/30/15
- Methods and Results draft: 11/13/15
- Final Document: 11/30/15

### Overview
The goal of my project is to look at demographic shifts in the foreign-born community in Philadelphia between 1970-2010. It can easily be argued that Philadelphia (and many urban areas) has been actively devitalized since the 1970s. As will be shown in this project, Philadelphia lost over 300,000 residents in the 1970s, a reduction of over 13%. This is equivalent to half of the residents in Washington, DC leaving Philadelphia in the span of 10 years. In each subsequent census, the trend continued until a slight increase occured in 2010. Closer analysis of this 1% population increase shows that the growth is attributed to an increase in foreign-born residents in Philadelphia. This project seeks to explore the changing demographics within the city.

For this project, I consulted three faculty members: Eugene Brusilovsky, Irma Elo, and Amy Hillier.  Eugene Brusilovsky is a professor of statistics in the MUSA program (Masters in Urban Spatial Analytics). Eugene recommended normalizing the data by using density to describe each census tract and to use regression analysis for the relationship between immigrant communities, land use, and crime. Eugene recommends using dummy variables to indicate the presence of commercial corridors in each census tract. Further, Eugene has noted that block group data would be ideal but that the census might suppress responses from the foreign born at the block level because some areas are likley to have few foreign born individuals. Dr. Elo in the sociology department suggested other data sets, for example the American Housing Survey, and the Economic Census. Dr. Elo recommended looking at the relationship between median home value and U.S. citizenship for the foreign-born community. Dr. Hillier concurs that block groups would be ideal for looking at proximty to commerical spaces but that the margin of error must be taken into consideration. Failure to do so may lead to over/under representation of the foreign-born community.


### Introduction 
In this project I will explore the research question "What is the relationship between immigration and revitalization in Philadelphia?". I started this project last semester in a studio class and want to replicate the results in R. In my previous project, I attempted to match 1980 census data to 2010 and was unable to analyze tracts that had changed boundaries. In revisiting this research question, I was able to locate data sources that allow me to conduct a longitudinal analysis via crosswalk tables from National Historic GIS (NHGIS) and the Longitudinal Tract Database (LTDB). The story regarding "urban revitalizaion" is often discussed through the process of gentrification. Using the knowledge that I gained from previous work on this subject, I will show that Philadelphia's population growth, as well as elements associated with revitalization, is heavily impacted by demographic shifts in the native and foreign born communities within the city-limits.


This problem is interdiciplinary because it spans several fields. Through coding in R, there is a heavy data science component, as well as practices and insights gained from geography, criminology, sociology, and demography. I will start with an overview of the city's native- and foreign-born populations. I will then break out each group into more specific "place of birth" categories to understand migratory patterns within the United States for the native-born, and country of origin for the foreign-born. I will explore the relationship of the foreign-born population to areas considered key factors in revitalization: commercial activity and safety. I will investigate characteristics of the immigrant population by looking at English proficiency and year of immigration into the United States. I will also look at the changes in these demographics over time by examining census data between 1980 and 2010. Once scripted, I believe the analysis will be able to be run for one, or several, different cities. Philadelphia can be compared to other major cities. 


It is my hope that the results of this project act as a catalyst for future research. The dominant narrative regarding revitalization generally lacks a nuanced discussion on immigration. My belief is that this portfolio will add complexity to the way we describe the growth of urban areas. It is also my hope that immigrant communities will be acknowledged for their contributions in Philadelphia and that government officials will build policies that consciously support foreign-born residents and those yet to come.

### Methods
I will utilize data from the National Historic GIS [NHGIS](https://data2.nhgis.org/main), the Longitudinal Tract Database [LTDB](http://www.s4.brown.edu/us2010/Researcher/LTDB1.htm), and data related to land use and crime through [OpenDataPhilly](https://www.opendataphilly.org). NHGIS has allowed the census to be studied longitudinally by standardizing questions over time. The wording of both questions and answers have changed over time and so NHGIS has identified the variable names for questions that are consistently asked and arranged them into time-series data sets. In particular, I will be looking at questions regarding count of persons by nativity (native-born vs foreign born), native-born persons by place of birth, and foreign-born persons by place of birth. In a similar manner, the LTDB creates crosswalk tables to compare changes in geography over time. Because census tract boundaries change as populations grow and decline, the LTDB has calculated the approximate area of a tract in 2010 that was formerly part of a census tract (or tracts) in previous decades. Doing so allows social scientists to compare geographic areas using a singular data set (in this case the 2010 census boundaries) and identify demographic shifts by census tract. I will combine the NHGIS data with the LTDB data and invesitigate several relationships between the native- and foreign-born communities.

R Code:
```{r warning=FALSE, message=FALSE}
#setwd("E:/UPENN/EPID 600/Final Project/Files for project")
setwd("J:/UPENN/EPID 600/Final Project/Files for project")

library(RCurl)
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggmap)
library(foreign)
library(rgdal)
library(rgeos)
library(maptools)
library(RColorBrewer)
library(stringr)


options(scipen=999)

#Assign city
  #Philadelphia  42   101
  #DelCo PA      42    45
  #DC            11     1
  #MontCo MD     24    31    
  #Baltimore     24   510
  #Atlanta       13   121
  #Portland      41    51
  #San Francisco 06    75

#These two variables identify the FIPS code for the state and county of interest. These are the only two variables that need to be changed to create different county profiles.
stateFIPS <- '42'
countyFIPS <-  101
#These two variables will be used to filter data later in the script
findFIPS <- paste(stateFIPS,str_pad(countyFIPS, 3, pad="0"),sep="")
filterFIPS <- paste("^",findFIPS,sep="")
```

```{r warning=FALSE}
#Bring in codebook to give readable titles to variable names
Codes <- getURL("https://raw.githubusercontent.com/rjake/FinalProject/master/Codebook.csv")%>%
  read.csv(text=., header = TRUE, sep=",")%>%
  as.data.frame()

  #Codes <- read.csv("Codebook.csv",stringsAsFactors=FALSE)

#read in county level NHIS data
County <- getURL("https://raw.githubusercontent.com/rjake/FinalProject/master/nhgis_ts_nominal_county.csv")%>%
  read.csv(text=., header = TRUE, sep=",",stringsAsFactors=FALSE,na.strings=c("", "NA"))%>%
  as.data.frame()

  #County <- read.csv("nhgis_ts_nominal_county.csv",stringsAsFactors=FALSE,na.strings=c("", "NA"))

#CityName will be used in the titles of charts and tables and to filter data later in the script
CityName <- ifelse(stateFIPS=="11", paste("District of Columbia"), 
                   filter(County,(STATEA==stateFIPS) & (COUNTYA==countyFIPS)& (YEAR=="2008-2012"))%>%
                      select(COUNTY,STATE)%>%
                      slice(1)%>%
                      paste(collapse=", "))
CityName 


City <- County %>%
            filter((STATEA==stateFIPS) & (COUNTYA==countyFIPS)) %>%
            select(-ends_with("M")) %>%
            select(which(unlist(lapply(., function(x)!all(is.na(x))))))%>%
            select(-c(1,3:7)) %>%
            gather("Var","Total",2:length(.)) %>%
            left_join(Codes,by="Var")

```






### Results
First I will show the changes across the county from 1970-2010
```{r}
#Net Population Growth
TotalPop <- City%>%
  filter(Question == 'Citizenship')

  TotalPop$Pop <- TotalPop$Pop %>%
    as.factor()%>%
    factor(., levels=rev(levels(.)))
  
    #As stacked bar chart
      ggplot(TotalPop, aes(YEAR,Total, fill=factor(Pop), order=Pop))+
        geom_bar(stat="identity", color="black")+
        scale_fill_manual(values=c("gray40", "gray70"))+
        theme_bw()+
        ggtitle(paste("Population Totals for Native & \nForeign Born Residents","\nfor ",CityName,sep=""))+
      theme(plot.title = element_text(hjust = 0,size=20))
 
    #As a line graph   
      ggplot(TotalPop, aes(YEAR,Total,Pop,group=Pop,color=Pop))+
        geom_line(size=1,linetype = 2)+
        geom_point(size=4.5)+
        scale_color_manual(values=c("black", "gray40"))+
        theme_bw()+
        ggtitle(paste("Population Totals for Native & \nForeign Born Residents", "\nfor ",CityName,sep=""))+
      theme(plot.title = element_text(hjust = 0,size=20))
```
These graphs show that the native-born population continues to decline and the foreign-born population is increasing. 


Here I break out the proportion of native born residents who are born in state vs. those born in another state.
```{r}
#Native Born
  NBorn <- City %>%
    filter(Pop=="Native Born" & Question=="Place of Birth")%>%
    filter(Qual=='In State'|Qual=='Other State')

    #total pop  
    ggplot(NBorn, aes(YEAR,Total, fill=factor(Qual), order=Qual))+
        geom_bar(stat="identity")+
            scale_fill_manual(values=c("gray40", "gray70"))+
            theme_bw()+
            ggtitle(paste("Native Born Residents in \n",CityName,sep=""))+
          theme(plot.title = element_text(hjust = 0,size=18))
            
      #born in state or in another state
        ggplot(NBorn, aes(YEAR,Total))+
          geom_bar(stat="identity")+
          facet_wrap(~Qual)+
          theme_bw()+
          ggtitle(paste("Birth Place of Native Born Residents in \n",CityName,sep=""))+
          theme(plot.title = element_text(hjust = 0,size=16))+
          theme(axis.text.x = element_text(angle = 90, hjust = 1))
```



Here I look at each region separately
```{r}
      #by specific location
      NBorn2 <- NBorn%>%
        filter(Qual=="Other State" & Qual2!="total")
    
      #each year by Region  
        ggplot(NBorn2, aes(YEAR,Total))+
          geom_bar(stat="identity")+
          facet_wrap(~Qual2, ncol=4)+
          theme_bw()+
          ggtitle(paste("Birth Place of Native Born Residents in \n",CityName," by Region",sep=""))+
          theme(plot.title = element_text(hjust = 0,size=18))+
          theme(axis.text.x = element_text(angle = 90, hjust = 1))
    
      #each region by year
        ggplot(NBorn2, aes(Qual2,Total))+
          geom_bar(stat="identity")+
          facet_wrap(~YEAR)+
          theme_bw()+
          ggtitle(paste("Birth Place of Native Born Residents in \n",CityName," by Year",sep=""))+
          theme(plot.title = element_text(hjust = 0,size=18))+
          theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
This shows that the number of residents who were born in-state has steadily declined since 1970 while the residents who were born out-of state has fluctuated and currenly higher than in 2000. The first chart shows that migration from the South was most pronounced in the 1970s and 1980s and has since lowered. The Northeast and West are increasing, with the Northeast becoming the largest group represented in Philadelphia.


Here I look at foreign-born residents:
```{r} 
#Foreign Born
#This is the main table used to create the other two tables, place of birth (Qual2) is more specific (Ex. N. Europe, China)
FBornSpec<-City %>%
  filter(Pop=="Foreign Born" & Question=="Place of Birth") %>%
  filter(YEAR!=1980 & YEAR!=2000)   

#This is a more generalized location for place of birth (Ex. Europe, Asia)       
FBornGen <- FBornSpec %>%
  group_by(YEAR,Qual)%>%
  summarise(Total=sum(Total))%>%
  filter(!is.na(Total))

#This is the total Count for each decade
FBornTotal <- FBornGen %>%
  group_by(YEAR)%>%
  summarise(Total=sum(Total))%>%
  mutate(Pop='Foreign Born')
    
    #total foreign-born pop by year
      ggplot()+
        geom_bar(data=FBornGen, aes(YEAR,Total, fill=Qual),color="black", stat="identity", position="dodge")+
        scale_fill_brewer(palette="PRGn")+
        geom_point(data=FBornTotal, aes(YEAR, Total,Pop,group=Pop),size=3.5, color="grey40")+
        geom_line(data=FBornTotal, aes(YEAR, Total,Pop,group=Pop),size=1, color="grey40", linetype=2)+
        theme_bw()+
        ggtitle(paste("Birth Place of Foreign Born Residents \nand Total Foreign-Born Population", "\nin ",CityName," by Year",sep=""))+
        theme(plot.title = element_text(hjust = 0,size=18))
       

    
    #by location
    ggplot(FBornGen, aes(YEAR,Total))+
      geom_bar(stat="identity")+
      facet_wrap(~Qual)+ 
      theme_bw()+
      ggtitle(paste("Population Totals for Foreign Born Residents in \n",CityName," by Region ",sep=""))+
      theme(plot.title = element_text(hjust = 0,size=20))
```
From these two charts you can see that Europeans have signficiantly declined since the 1970s and groups from Africa, the Americas (Central & South), and Asia have been growing each decade. Asis is currently the largest immigrant group in Philadelphia.


To compare tract growth, I had to create crosswalk tables from the LTDB and NHGIS data:
```{r}
#TRACT GROWTH
#Read in each crosswalk table, format correctly then rowbind
  LTDBx1970 <- getURL("https://raw.githubusercontent.com/rjake/FinalProject/master/LTDB%20crosswalk_1970_2010.csv")%>%
          read.csv(text=., header = TRUE, sep=",",stringsAsFactors=FALSE,na.strings=c("", "NA"))%>%
            #read.csv("LTDB crosswalk_1970_2010.csv",stringsAsFactors=FALSE)%>%
        #add year of original tract column
         mutate(YEAR=1970)%>%
        #add leading zeros to FIPS, combine with year to create a look up to match with NHGIS census tract data (below)
        mutate(tractid=str_pad(trtid70, 11, pad="0"))%>%
        mutate(LOOKUP=paste(YEAR,tractid,sep="_"))%>%
        #subset to City tracts  
        filter(substr(tractid,1,5)==findFIPS)%>%
        #select uniform columns
        select(YEAR, LOOKUP, weight, trtid10)
          
  LTDBx1980 <-  getURL("https://raw.githubusercontent.com/rjake/FinalProject/master/LTDB%20crosswalk_1980_2010.csv")%>%
          read.csv(text=., header = TRUE, sep=",",stringsAsFactors=FALSE,na.strings=c("", "NA"))%>%
    #read.csv("LTDB crosswalk_1980_2010.csv",stringsAsFactors=FALSE)%>%
        mutate(YEAR=1980)%>%
        mutate(tractid=str_pad(trtid80, 11, pad="0"))%>%
        mutate(LOOKUP=paste(YEAR,tractid,sep="_"))%>%
        filter(substr(tractid,1,5)==findFIPS)%>%
        select(YEAR, LOOKUP, weight, trtid10)
      
  LTDBx1990 <-  getURL("https://raw.githubusercontent.com/rjake/FinalProject/master/LTDB%20crosswalk_1990_2010.csv")%>%
          read.csv(text=., header = TRUE, sep=",",stringsAsFactors=FALSE,na.strings=c("", "NA"))%>%
    #read.csv("LTDB crosswalk_1990_2010.csv",stringsAsFactors=FALSE)%>%
        mutate(YEAR=1990)%>%
        mutate(tractid=str_pad(trtid90, 11, pad="0"))%>%
        mutate(LOOKUP=paste(YEAR,tractid,sep="_"))%>%
        filter(substr(tractid,1,5)==findFIPS)%>%
        select(YEAR, LOOKUP, weight, trtid10)
      
  LTDBx2000 <-  getURL("https://raw.githubusercontent.com/rjake/FinalProject/master/LTDB%20crosswalk_2000_2010.csv")%>%
          read.csv(text=., header = TRUE, sep=",",stringsAsFactors=FALSE,na.strings=c("", "NA"))%>%
    #read.csv("LTDB crosswalk_2000_2010.csv",stringsAsFactors=FALSE)%>%
        mutate(YEAR=2000)%>%
        mutate(tractid=str_pad(trtid00, 11, pad="0"))%>%
        mutate(LOOKUP=paste(YEAR,tractid,sep="_"))%>%
        filter(substr(tractid,1,5)==findFIPS)%>%
        select(YEAR, LOOKUP, weight, trtid10)

#combine all into one table      
  CrossWalk <- rbind(LTDBx1970, LTDBx1980, LTDBx1990, LTDBx2000)
```
  
Merge tables  
```{r warning=FALSE}      
#Read in NHGIS tracts for Native & Foreign Born 1970-2012
Tracts <-  getURL("https://raw.githubusercontent.com/rjake/FinalProject/master/nhgis_ts_nominal_tract.csv")%>%
          read.csv(text=., header = TRUE, sep=",",stringsAsFactors=FALSE,na.strings=c("", "NA"))%>%
      #read.csv("nhgis_ts_nominal_tract.csv",stringsAsFactors=FALSE)%>%
          #chose just state and county of interest
            filter((STATEA==stateFIPS) & (COUNTYA==countyFIPS)) %>%
          #rename 2008-2012 year to 2010 (makes an interger)  
            mutate(YEAR=ifelse(YEAR=="2008-2012",2010,YEAR))%>%
          #select just the variables of interest  
            select(NHGISCODE,YEAR, AT5AA,AT5AB) %>%
          #Convert to long form
            gather("Var","Total",3:4) 

#Extract FIPS code from NHGISCODE, create matching lookup code to join tables in next step
TractFIPS <- Tracts %>% 
    mutate(FIPS=paste(substr(NHGISCODE,2,3), 
                      substr(NHGISCODE,5,7), 
                      substr(NHGISCODE,9,14), sep=""))%>%
    mutate(LOOKUP=paste(YEAR, "_", FIPS, sep=""))

#  head(TractFIPS)

#Shortens table, creates lookup code
TractHistory <- TractFIPS%>%
  select(Var,YEAR,Total,LOOKUP,FIPS)%>%
  left_join(CrossWalk, by="LOOKUP")%>%
#  mutate(Total2010=round(Total*weight,0))%>%
  mutate(Total2010=ifelse(YEAR.x=="2010",Total,round(Total*weight,0)))%>%
  mutate(Total2010=ifelse(Total2010<10,0,Total2010))%>%
  mutate(trtid10=ifelse(YEAR.x=="2010",FIPS,trtid10))%>%
  left_join(Codes,by="Var")
  
#  head(TractHistory)  
#  head(filter(TractHistory,YEAR.x=="2010"))
```

```{r}
#Transforms data to wide form using "spread"" function
  TractSpread <- TractHistory%>%
    select(YEAR.x,trtid10,Total2010,Pop)%>%
    rename(Year=YEAR.x)%>%
    rename(Total=Total2010)%>%
    mutate(Measure=ifelse(Pop=="Native Born", paste("n",Year,"NB", sep=""),paste("n",Year,"FB", sep="")))%>%
    select(trtid10,Total,Measure)%>%
    group_by(trtid10,Measure)%>%
    summarise(Total=sum(Total))%>%
    spread(Measure,Total)%>%
    replace(is.na(.), 0)
#head(TractSpread)

#Creates columns to look at change in each census tract between 1980-2010
Tracts80to10 <- TractSpread%>%
  mutate(d80to10NB=n2010NB-n1980NB)%>%
  mutate(d80to10FB=n2010FB-n1980FB)%>%
  select(trtid10,d80to10FB,d80to10NB)%>%
  mutate(Change=ifelse((d80to10FB>0 & d80to10NB>0),"Both Increase",
                 ifelse(d80to10FB>0 & d80to10NB<=0,"FB Increase Only",
                 ifelse(d80to10FB<=0 & d80to10NB>0,"NB Increase Only",
                 ifelse(d80to10FB<0 & d80to10NB<0,"Both Decrease","-")))))


#head(Tracts80to10)                     

#Shows a scatter plot of tracts that have had increases, decreases or no change in the native-/foreign-born populations
ggplot(Tracts80to10, aes(d80to10NB, d80to10FB, color=factor(Change)))+  
  geom_point()+
  geom_abline(intercept = 0, slope = 0)+
  geom_vline(xintervept=0)+
  coord_fixed()+
  theme_bw()+
  ggtitle(paste("Growth of Native Born and Foreign Born Populations in \n",CityName," between 1980-2010 ",sep=""))+
  theme(plot.title = element_text(hjust = 0,size=16))
  
#provides a table
as.data.frame(table(Tracts80to10$Change))%>%
  mutate(Pct=round(Freq/sum(Freq),2))
```
This chart shows that 46% of the tracts in Philadelphia have had an increase in the foreign-born population without an increase in the native-born population as well. This is in stark comparison to the 7% of tracts that have only had increases in the native born and 19% where there has been growth of both groups. It is noticable that over 25% of census tracts have seen reductions in both populations.


```{r}
#This adds two columns to the Tracts80to10 table in order to arrange tracts by growth/loss
DistGrowth<-Tracts80to10%>%
  arrange(desc(d80to10NB))%>%
  mutate(OrderNB=row_number())%>%
  arrange(desc(d80to10FB))%>%
  mutate(OrderFB=row_number())
head(DistGrowth)

#Shows the distribution of growth/loss of native-born population
  ggplot(DistGrowth, aes(x=OrderNB,y=d80to10NB))+  
    geom_bar(stat="identity",position="identity",fill="blue",color=NA, width=1.5)+
    #geom_bar(aes(y=d80to10NB), stat="identity",position="identity",fill="blue",color=NA, width=1)+
  #  coord_fixed()+
    theme_bw()+
    ggtitle(paste("Census Tracts Arranged from Most Growth to Most Loss in the \nNative Born Population in ",CityName,"\nbetween 1980-2010 ",sep=""))+
    theme(plot.title = element_text(hjust = 0,size=16))
  
  
#Shows the distribution of growth/loss of foreign-Born population
  ggplot(DistGrowth, aes(x=OrderFB,y=d80to10FB))+  
    geom_bar(stat="identity",position="identity",fill="orange",color=NA, width=1.5)+
    #geom_bar(aes(y=d80to10NB), stat="identity",position="identity",fill="blue",color=NA, width=1)+
    theme_bw()+
    ggtitle(paste("Census Tracts Arranged from Most Growth to Most Loss in the \nForeign Born Population in ",CityName,"\nbetween 1980-2010 ",sep=""))+
    theme(plot.title = element_text(hjust = 0,size=16))

#Shows growth of Foreign Born Population given the distribution of the Native Born Population
  ggplot(DistGrowth, aes(x=OrderNB,y=d80to10NB))+  
    geom_bar(stat="identity",position="identity",fill="blue",color=NA, width=1.5)+
    geom_bar(aes(y=d80to10FB), stat="identity",position="identity",fill="orange",color=NA, width=1)+
    theme_bw()+
    ggtitle(paste("Growth of Foreign Born Population (orange) given the \nGrowth of the Native Born Population (blue) \nin ",CityName," between 1980-2010 ",sep=""))+
    theme(plot.title = element_text(hjust = 0,size=18))

#Shows growth of Native Born Population given the distribution of the Foreign Born Population    
  ggplot(DistGrowth, aes(x=OrderFB,y=d80to10FB))+  
    geom_bar(stat="identity",position="identity",fill="orange",color=NA, width=1.5)+
    geom_bar(aes(y=d80to10NB), stat="identity",position="identity",fill="blue",color=NA, width=1)+
    theme_bw()+
    ggtitle(paste("Growth of Native Born Population (blue) given the \nGrowth of the and Foreign Born Population (orange) \nin ",CityName," between 1980-2010 ",sep=""))+
    theme(plot.title = element_text(hjust = 0,size=18))

#  mutate(d70to80NB=n1980NB-n1970NB)%>%
#  mutate(d80to90NB=n1990NB-n1980NB)%>%
#  mutate(d90to00NB=n2000NB-n1990NB)%>%
#  mutate(d00to10NB=n2010NB-n2000NB)
#head(TractComparison)
    
```

#NEEDS TO BE FINISHED   
```{r eval=FALSE} 
#CREATE CHOROPLETH MAP  
###################################################  
#                   WORKS                         #
###################################################  
getwd()
  tract <- readOGR(dsn=".", layer="US_tract_2010", stringsAsFactors=FALSE)
  CBSA <- 
  tractCity <- tract[grepl(filterFIPS,tract$GEOID10),]      
  
  plot(tractCity)
  
  #fortify shapefile for use in ggplot
    ggtract <- fortify(tractCity, region="GEOID10")
  
    ggplot(data=ggtract, aes(y=lat, x=long, group=group, fill="id"))+
      geom_polygon(color="black") +
#      scale_fill_manual(values="white")+
       guides(fill=FALSE)+
      coord_fixed())
```

      

```{r eval=FALSE}  
  #read in tract comparison data
    data <- read.csv("TractComparison.csv", stringsAsFactors=FALSE)
      #make sure FIPS/GEOID10 is character string
        data$GEOID10 <- as.character(data$GEOID10)
      #change name for join to ggtract
        names(data)[1] <- "id"
    
  #dev.off()
  
  
#Goal: Make long form of difference between decades for ggplot: 
#Steps: Takes [data], grabs column w/ "d" (the columns that show difference in population between decades), converts it to long form (gather), identifies which values are re: foreign born [Category] <- (contains "FB" in "Measure"), Groups by Category to identify standard deviations [SDValues], cuts these to make categories of -3:3+ s.dev [SD], joins ggtract (fortified .shp of census tracts)
  DiffBoth <- data %>%
    select(id, starts_with("d")) %>%
    gather("Measure","Value", starts_with("d"))%>%
    mutate(Category=grepl("FB", Measure))%>%
    group_by(Category)%>%
    mutate(SDValue=round(Value/sd(Value),2))%>%
    mutate(SD=cut(SDValue,breaks=c(-Inf,-3,-2,-1,1,2,3,Inf)))%>%
    left_join(.,ggtract)
  
#same as above but Counts by census tract per decade  
  nBoth <- data %>%
    select(1:13) %>%
    gather("Measure","Value", 2:13)%>%
    mutate(Category=grepl("FB", Measure))%>%
    group_by(Category)%>%
    mutate(SDValue=round(Value/sd(Value, na.rm=TRUE),2))%>%
    mutate(SD=cut(SDValue,breaks=c(0,1,2,3,Inf)))%>%
    left_join(.,ggtract)
  
#Assign colors for standard deviation categories  
    #sd.fillX <- c("orangered3", "chocolate1", "darkgoldenrod", "gray5", "gray5", "thistle3", "mediumpurple3", "mediumpurple4")

    sd.fill <-c(brewer.pal(name="PuOr",n=7)[c(1,2,3)], "white", brewer.pal(name="PuOr",n=7)[c(5,6,7)])
    
    sd.color <- c("gray45", "gray45", "gray45", "gray75", "gray45", "gray45", "gray45") # rep("gray75",8)
    
#    sd.alpha <- c()
```



```{r eval=FALSE, dpi=400}        
#Goal: Function to map standard deviations in Philadelphia (convert to function?)
#Steps: [fill] is dynamic as [SD] is a standardized column, 
        #[element_blank()] removes axes labels
        #[scale_fill_manual] uses colors assigned to standard deviation (previous command)
    
  #Turn this into a function
    mapSD <- function(x,z)
    { ggplot(x)+
        geom_polygon(aes(x=long, y=lat, group=group, fill=factor(SD),color=factor(SD)), size=0.1)+
        theme(line=element_blank(), axis.text=element_blank(),axis.title=element_blank())+
        scale_fill_manual(values=sd.fill,guide=guide_legend(reverse=TRUE))+
        scale_color_manual(values=sd.color,guide=guide_legend(reverse=TRUE))+
        coord_fixed()+
        #theme(legend.position="bottom")+
        facet_wrap(~Measure, ncol=z)+
        theme(panel.background=element_rect(fill="grey30"))#"grey90"))=NA
    } 
#Map Difference between decades using mapSD function above, facet wrap with 4 columns
    mapSD(DiffBoth,4)
    
#Map Counts by decade using mapSD fucntion above, facet wrap with 5 columns
    #mapSD(nBoth,6)
    ggplot(nBoth)+
      geom_polygon(aes(x=long, y=lat, group=group, fill=factor(SD),color=factor(SD)), size=0.05)+
      theme(line=element_blank(), axis.text=element_blank(),axis.title=element_blank())+
      scale_fill_manual(values=sd.fill[4:7])+
      scale_color_manual(values=sd.color[4:7])+
      coord_fixed()+
      theme(legend.position="bottom")+
      facet_wrap(~Measure, ncol=6)+
      theme(panel.background=element_rect(fill="grey30"))

```



#UNUSED
```{r eval=FALSE}
#####
#rename Columns
#for (i in 6:length(County)){
#  a <- colnames(County[i])
#  a
#  b <- Codes$Readable[match(a, Codes$Code)] 
#  b
#  names(County)[i] <- b
#}
#t(County[,6:length(County)])

  
  #EXTRAS
  #http://zevross.com/blog/2015/10/14/manipulating-and-mapping-us-census-data-in-r-using-the-acs-tigris-and-leaflet-packages-3/
  
  #https://cran.r-project.org/doc/contrib/intro-spatial-rl.pdf
  
  #http://stat405.had.co.nz/ggmap.pdf
  #http://www.r-bloggers.com/maps-with-r-and-polygon-boundaries/
```